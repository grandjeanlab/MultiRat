---
title: "MultiRAT analysis code"
output: github_document
author: 'Joanes Grandjean'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

![rat art](assets/img/rat_art.png)

# RABIES argument justification
RABIES is run in 3 steps (preprocessing, confound_regression, analysis). Here I justify my selection of arguments. Below is a full `preprocessing` command with the augments I used.

`rabies --plugin MultiProc preprocess --no_STC --anat_template $template --brain_mask $template_mask --WM_mask $template_WM --CSF_mask $template_CSF --vascular_mask $template_CSF --labels $atlas --autoreg --commonspace_resampling 0.35x0.35x0.35 --anatomical_resampling 0.25x0.25x0.25 $analysis_folder/bids $analysis_folder/preprocess`

`--plugin MultiProc` : I run this software on a high-performance cluster (HPC). Due to software installation limitation, I've built RABIES into a singularity. While using the singularity mode, I cannot use the traditional job submission (PBS) mode. Users interesting in running the software on their environment will need to adapt this section. 

'--no_STC' : Unfortunately, it is not possible to ensure the slice acquisition sequence for every dataset reliably. For short-TR sequences (TR < 2s), slice timing correction is through to only improve marginally. 

`-anat_template $template --brain_mask $template_mask --WM_mask $template_WM --CSF_mask $template_CSF --vascular_mask $template_CSF --labels $atlas` : The templates and masks arguments assume the assets have been prepared as described in [2. Asset preparation](proj_asset.md). Notably, there was not vascular map available with the template. In [Grandjean et al. 2020](https://www.sciencedirect.com/science/article/pii/S1053811919308699), I generated a vascular mask from the data by identifying overlapping ICA components. It is unclear before preprocessing if I will find such components in rat. Also, a vascular mask is a prerequisite for running the `confound_regression` command. 

`--autoreg` : as of the version used, this is the recommended registration argument. 

`--commonspace_resampling 0.35x0.35x0.35 --anatomical_resampling 0.25x0.25x0.25` : Due to space / computer time constrains, I have to run the preprocessing with relative low resolution. Indeed, I am limited to 72h walltime per script, and some datasets would not complete running when using high resolutions. 

`$analysis_folder/bids $analysis_folder/preprocess` : The standard input / output arguments. 

# Script preparation. 
Because of the variable TR and other parameter, individual dataset are preprocessed separately. 
To accommodate that and generate the preprocessing script, I've prepared a R script to generate the preprocessing code. 

```{r prepare preprocessing, eval=FALSE}
library(stringr)

# Load bash environment variable, including asset location needed to make our RABIES call. 
readRenviron("bash_env.sh")
analysis_folder <- Sys.getenv("analysis_folder")
template <- Sys.getenv("template")
template_mask <- Sys.getenv("template_mask")
template_WM <- Sys.getenv("template_WM")
template_CSF <- Sys.getenv("template_CSF")
atlas <- Sys.getenv("atlas")
ROI <- Sys.getenv("ROI")


study <- read.csv('assets/table/meta_data.tsv',sep='\t') # Load the meta data (currently not available on public repository.)
output.script <- file.path(analysis_folder,'script',paste('run_rabies-',Sys.Date(),'.sh',sep=''))


ds.select <- c(1,2,3,4,5,6,7,8,9,10,11,12,13) # Select which dataset to preprocess
is.rs <- TRUE # Select if resting-state (TRUE) or stimulus-evoked (FALSE). Important because this will impact confound regression and analysis
use.singularity <- TRUE #select if it is run within a singularity environment (not currently implemented)
use.qsub <- TRUE #Select if you want to submit calls using qsub job submission command (for HPC). 

# Prepare output directories 
dir.create(path = file.path(analysis_folder,'script'), recursive = TRUE, showWarnings = FALSE)
dir.create(path = file.path(analysis_folder,'tmp'), recursive = TRUE, showWarnings = FALSE)
dir.create(path = file.path(analysis_folder,'preprocess'), recursive = TRUE, showWarnings = FALSE)
dir.create(path = file.path(analysis_folder,'confound'), recursive = TRUE, showWarnings = FALSE)
dir.create(path = file.path(analysis_folder,'analysis'), recursive = TRUE, showWarnings = FALSE)
dir.create(path = file.path(analysis_folder,'qa'), recursive = TRUE, showWarnings = FALSE)


# Environment to be exported to PATH within the singularity. 
singularity.env <- 'export FSLDIR=/opt/fsl/6.0.1; export PATH=$PATH:$FSLDIR/bin; export ANTSPATH=/home/rabies/ants-v2.3.1/bin; export RABIES_VERSION=0.2.0-dev; export RABIES=/home/rabies/RABIES-0.2.0-dev; export PYTHONPATH="${PYTHONPATH}:$RABIES"; export PATH=$PATH:$RABIES/bin; export PATH=$PATH:$RABIES/rabies/shell_scripts; export PATH=$RABIES/twolevel_ants_dbm:$PATH;'

singularity.call <- paste('/opt/singularity/3.5.2/bin/singularity exec -B /opt/fsl -B ',analysis_folder,' /opt/rabies/0.2.0/rabies-0.2.0-dev.simg bash -c \'',sep='')

qsub.short <- ' |  qsub -l \'procs=1,mem=8gb,walltime=1:00:00\''
qsub.long <- ' |  qsub -l \'procs=1,mem=24gb,walltime=72:00:00\''

sink(output.script)

for( ds in ds.select){

  
#ds<-1
study.sub<-study[study$rat.ds == ds, ]
TR <- study.sub$func.TR[1]

mkdir.tmp.call <- paste('mkdir -p ',file.path(analysis_folder,'tmp',ds),sep='')
mv2tmp.call <- paste('cp -r ',file.path(analysis_folder,'bids_small',paste('sub-01',str_pad(ds, 3, pad = "0"),'*',sep='')),' ', file.path(analysis_folder,'tmp',ds),sep='')
mkdir.qa.call<- paste('mkdir -p ',file.path(analysis_folder,'qa',ds),sep='')
mv2qa.call <- paste('mv ',file.path(analysis_folder,'preprocess',ds,'QC_report/*'),' ', file.path(analysis_folder,'qa',ds),sep='')
rm.tmp.call <- paste('rm -r ',file.path(analysis_folder,'tmp',ds),sep='')

# RABIES preprocessing call
if(use.singularity){
rabies.preprocess.call <- paste('analysis_folder=',analysis_folder,'; rabies --plugin MultiProc preprocess --no_STC --anat_template ',template,' --brain_mask ', template_mask, ' --WM_mask ', template_WM, ' --CSF_mask ', template_CSF, ' --vascular_mask ',template_CSF, ' --labels ', atlas, ' --autoreg --commonspace_resampling 0.35x0.35x0.35 --anatomical_resampling 0.25x0.25x0.25 --TR ', TR, 's ', file.path(analysis_folder,'tmp',ds), ' ', file.path(analysis_folder,'preprocess',ds),sep='')
}else{
rabies.preprocess.call <- paste('analysis_folder=',analysis_folder,'; rabies preprocess --no_STC --anat_template ',template,' --brain_mask ', template_mask, ' --WM_mask ', template_WM, ' --CSF_mask ', template_CSF, ' --vascular_mask ',template_CSF, ' --labels ', atlas, ' --autoreg --commonspace_resampling 0.35x0.35x0.35 --anatomical_resampling 0.25x0.25x0.25 --TR ', TR, 's ', file.path(analysis_folder,'tmp',ds), ' ',file.path(analysis_folder,'preprocess',ds),sep='')}

# RABIES confound call (maybe make into a loop for every confound type in future.)

rabies.confound.call.aroma <- paste('analysis_folder=',analysis_folder,'; rabies confound_regression ', file.path(analysis_folder,'preprocess',ds),' ',file.path(analysis_folder,'confound',ds), ' --commonspace_bold --highpass 0.01 --lowpass 0.1 --smoothing_filter 0.5 --diagnosis_output --run_aroma --TR ', TR, 's',sep='')

# RABIES analysis call (maybe make into a loop for every ROI in the future)
rabies.analysis.call <- paste('analysis_folder=',analysis_folder,'; rabies analysis ', file.path(analysis_folder,'confound',ds),' ',file.path(analysis_folder,'analysis',ds), ' --seed_list ', ROI,'S1bf_l.nii.gz',sep='')


cat(paste('# now processing DS ',ds,sep=''))
cat("\n")

cat(mkdir.tmp.call)
if(use.qsub){cat(qsub.short)}
cat("\n")

cat(mv2tmp.call)
if(use.qsub){cat(qsub.short)}
cat("\n")
cat("\n")

if(use.singularity){cat(c(singularity.call,singularity.env))}
cat(rabies.preprocess.call)
if(use.singularity){cat("\'")}
if(use.qsub){cat(qsub.long)}
cat("\n")
cat("\n")


if(use.singularity){cat(c(singularity.call,singularity.env))}
cat(rabies.confound.call.aroma)
if(use.singularity){cat("\'")}
if(use.qsub){cat(qsub.long)}
cat("\n")
cat("\n")


cat(mv2qa.call)
if(use.qsub){cat(qsub.short)}
cat("\n")

cat(rm.tmp.call)
if(use.qsub){cat(qsub.short)}
cat("\n")
cat("\n")

if(use.singularity){cat(c(singularity.call,singularity.env))}
cat(rabies.analysis.call)
if(use.singularity){cat("\'")}
if(use.qsub){cat(qsub.long)}
cat("\n")
cat("\n")
cat("\n")


}

sink()
```


